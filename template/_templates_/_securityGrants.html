[%divId="securityGrants"%]
[%spwfResource="security_profile"%]
[%prkey="security_profile_id"%]
[%prettyName="Security Profile"%]

<script type="text/javascript">
  //<![CDATA[
"use strict";
//Server Calls
function retrieve[%ucfirst(divId)%]List(){
  $("#[%divId%]ListTable").html("");
  var params =prepParams(params,"[%spwfResource%]" ,"select" );
  var successf = function (rslt){
    if(!rslt[SERVER_SIDE_FAIL]){
      populate[%ucfirst(divId)%](rslt.rows);
    }else{
      briefNotify("There was a problem communicating with the Server.","ERROR")
    }

  };
  serverCall(params,successf,FAILF);
}
function retrieve[%ucfirst(divId)%](params){
  params = prepParams(params,"[%spwfResource%]","SELECT");
  var successf = function(rslt){
    if(!rslt[SERVER_SIDE_FAIL]){
      bindToForm("[%divId%]Form", rslt.rows[0]);
      toggleSaveMode("[%divId%]Form",true);
    }else{
      briefNotify("There was a problem communicating with the Server.","ERROR")
    }

  }
  serverCall(params,successf,FAILF);
}



function delete[%ucfirst(divId)%]([%toCC(prkey)%]_, lastUpdate_){
  var params =prepParams(params,"[%spwfResource%]" ,"delete" );
  params['[%prkey%]'] = [%toCC(prkey)%]_;
  params['last_update'] = lastUpdate_;
  var successf = function (rslt){
    if(!rslt[SERVER_SIDE_FAIL]){
      remove[%ucfirst(divId)%]ListTableRow(rslt.[%prkey%]);
      briefNotify("Golf Score Deleted Successfully","INFO");
    }else{
      briefNotify("There was a problem communicating with the Server.","ERROR")
    }

  };
  serverCall(params,successf,FAILF);
}

function save[%ucfirst(divId)%](params){
  params = prepParams(params,"[%spwfResource%]",insertUpdateChoose);
  var successf=function(rslt){
    if(!rslt[SERVER_SIDE_FAIL]){
      clearForm('[%divId%]Form');
      if (rslt.spwfAction == "UPDATE"){
	replace[%ucfirst(divId)%]ListTableRow(rslt.rows[0]);
      }else if (rslt.spwfAction == "INSERT"){
	addNew[%ucfirst(divId)%]ListTableRow(rslt.rows[0]);
      }
      briefNotify("[%prettyName%] Successfully Saved");
    }else{
      briefNotify("There was a problem communicating with the Server.","ERROR")
    }

  };
  serverCall(params,successf,FAILF);
}

//ServerCall Wrappers
function edit[%ucfirst(divId)%]([%divId%]Id_){
  if([%divId%]Id_){
    makeAvailableAllPrivileges();
    var params ={"where_clause":"[%prkey%]=" +[%divId%]Id_};
    retrieve[%ucfirst(divId)%](params);
    retrieveAllGrantedPrivilegesList([%divId%]Id_);
  }
}

function save[%ucfirst(divId)%]Form(){
  if(validate[%ucfirst(divId)%]Form()){
    var params = bindForm("[%divId%]Form");
    save[%ucfirst(divId)%](params);
  }
}

//validation
function validate[%ucfirst(divId)%]Form(){
  var formName="[%divId%]Form";
  var formValid  = standardValidate(formName);
  return formValid;
}

//Top Level HTML Manip
function populate[%ucfirst(divId)%](dataRows){
  var htmlAggregator ="<tr><th>Profile Name</th><th class='accentColumn'>I want to&hellip;</th></tr>";
  for(var ndx=0;ndx< dataRows.length;ndx++){
    htmlAggregator +=build[%ucfirst(divId)%]ListTableRow(dataRows[ndx]);
  }
  $("#[%divId%]ListTable").html(htmlAggregator);
}

function build[%ucfirst(divId)%]ListTableRow(data){
  var htmlRow ="<tr id='[%ucfirst(divId)%]ListTableTR-" +data.[%prkey%] + "'><td>";
  htmlRow += data.profile_name  +"</td>";
  htmlRow += "<td class='accentColumn'><a class='alink' onclick='edit[%ucfirst(divId)%](" +data.[%prkey%] + ")'>Edit</a> |"
    htmlRow += "<a class='alink' onclick=\"delete[%ucfirst(divId)%](" +data.[%prkey%] + ",'"+data.last_update +"')\">Delete</a>  </td> </tr>";
  return htmlRow;
}

function replace[%ucfirst(divId)%]ListTableRow(row){
  $("table#[%divId%]ListTable #[%ucfirst(divId)%]ListTableTR-"+row.[%prkey%]).replaceWith(build[%ucfirst(divId)%]ListTableRow(row));
}
function addNew[%ucfirst(divId)%]ListTableRow(row){
  $("table#[%divId%]ListTable TR").first().after(build[%ucfirst(divId)%]ListTableRow(row));
}
function remove[%ucfirst(divId)%]ListTableRow([%toCC(prkey)%]_){
  $("table#[%divId%]ListTable #[%ucfirst(divId)%]ListTableTR-"+[%toCC(prkey)%]_).replaceWith("");
}

//Div Access and App Layout Calls
function show[%ucfirst(divId)%](){
  retrieve[%ucfirst(divId)%]List(); 
  hideCurrentContentPane();
  $("#[%divId%]").fadeIn();
  currentContentPane="[%divId%]";
  toggleSaveMode("[%divId%]Form",false);
  retrieveAllAvailablePrivilegesList();
}

//After complete Load setup
$(document).ready(function(){

    $("#availableGrantsId").droppable({accept:".securityGrant", drop:handleSecurityRevokeDrop});
    $("#grantedPrivilegesId").droppable({accept:".securityGrant", drop:handleSecurityGrantDrop});

    });

//page specific functions
var allAvailablePrivilegeList;
function retrieveAllAvailablePrivilegesList(){
  var params =prepParams(params,"security_privilege" ,"select" );
  var successf = function (rslt){
    allAvailablePrivilegeList = deepCopy(rslt.rows);
    populateAvailableGrantsWithAll();
  };
  serverCall(params,successf,FAILF);
}

function populateAvailableGrantsWithAll(){
  var newOptions="";
  for(var ndx=0; ndx < allAvailablePrivilegeList.length;ndx++){
    newOptions += '<div class="securityGrant" id="securityGrant'+allAvailablePrivilegeList[ndx].security_privilege_id+'Id"><span class="securityGrantName"> '+allAvailablePrivilegeList[ndx].priv_name  +'</span> <span class="securityGrantDescription">' +allAvailablePrivilegeList[ndx].description + '</span></div>';
  }

  $("#availableGrantsId").html(newOptions);
  makeDragable(".securityGrant");
  $("#grantedPrivilegesId").children().remove();
}

function makeDragable(identifierTodraggable_){
  $(identifierTodraggable_).draggable({snap: ".securityGrantReceiver", revert:"invalid", scroll:false, helper:'clone' });
  if($(identifierTodraggable_).parent().attr('id') === "availableGrantsId"){
    $(identifierTodraggable_).dblclick(function(){
	attemptSecurityGrantRevoke("GRANT",$(this).attr('id') );
	});
  }
}

function retrieveAllGrantedPrivilegesList(profileId_){
  var params =prepParams(params,"security_profile_grant" ,"select" );
  params["where_clause"] = "security_profile_id=" +profileId_;
  var successf = function (rslt){
    var grants =  rslt.rows;
    for (var i =0; i< grants.length; i++){
      assignGrantStatus("securityGrant"+ grants[i].security_privilege_id + "Id", "GRANT");
    }
    sortDivChildren("#grantedPrivilegesId");
  };
  serverCall(params,successf,FAILF);
}


function handleSecurityGrantDrop( event, ui ){
  if(ui.draggable.parent().attr('id') !="grantedPrivilegesId")
    attemptSecurityGrantRevoke("GRANT", ui.draggable.attr('id'));
}
function handleSecurityRevokeDrop( event, ui ){
  if(ui.draggable.parent().attr('id') !="availableGrantsId")
    attemptSecurityGrantRevoke("REVOKE", ui.draggable.attr('id'));
}

function attemptSecurityGrantRevoke(grantOrRevoke_, divId_){
  var profileId = $("#[%divId%]Form-[%prkey%]").val();
  var privId = divId_.replace("securityGrant","");
  privId = privId.replace("Id","");
  if(!isEmpty(profileId)){
    if (grantOrRevoke_ === "GRANT"){//grant requeseted
      assignGrantStatus(divId_, "GRANT");
      grantPrivilege(privId, profileId);
    }else{//default to revoke
      assignGrantStatus(divId_, "REVOKE");
      revokePrivilege(privId, profileId);
    }
  }else{// div is auto removed if not assignGrantsStatus above called
    briefNotify("Please choose a profile");
  }

}

function assignGrantStatus(grantDivId_, status_){
  var fromLocation, toLocation;
  if (status_ == "GRANT"){fromLocation= "#availableGrantsId"; toLocation="#grantedPrivilegesId";
  } else{fromLocation= "#grantedPrivilegesId";toLocation="#availableGrantsId"; }
  fromLocation += " #"+grantDivId_;
  $(fromLocation).appendTo(toLocation);
  $(fromLocation).remove();
  makeDragable(toLocation + " #"+grantDivId_ );
}

function grantPrivilege(securityPrivilegeId_, securityProfileId_){
  var params =prepParams(params,"security_profile_grant" ,"insert" );
  params['security_privilege_id'] = securityPrivilegeId_;
  params['security_profile_id'] = securityProfileId_;
  params['passThru'] ="pendingDiv~securityGrant" + securityPrivilegeId_ + "Id;";
  var successf = function (rslt){
    if(!rslt['serverSideFail']) {
      briefNotify("Privilege Granted");
      sortDivChildren('#grantedPrivilegesId');
    }
    else{ 
      briefNotify('There was a problem granting this privilege');
      assignGrantStatus(rslt['PT_pendingDiv'],"AVAIL");
    }
  };
  serverCall(params,successf,FAILF);
}

function revokePrivilege(securityPrivilegeId_, securityProfileId_){
  var params =prepParams(params,"security_profile_grant" ,"deletew" );
  params['where_clause'] = 'security_privilege_id=' + securityPrivilegeId_ + ' and security_profile_id = ' + securityProfileId_ ;
  params['passThru'] ="pendingDiv~securityGrant" + securityPrivilegeId_ + "Id;";
  var successf = function (rslt){
    if(!rslt['serverSideFail']) {
      briefNotify("Privilege Revoked");
      sortDivChildren('#availableGrantsId');
    }else{ 
      briefNotify('There was a problem granting this privilege');
      assignGrantStatus(rslt['PT_pendingDiv'],"GRANT");
    }

  };
  serverCall(params,successf,FAILF);
}

function makeAvailableAllPrivileges(){

  $('#grantedPrivilegesId').children().remove();
  $('#availableGrantsId').children().remove();
  populateAvailableGrantsWithAll();
  sortDivChildren("#availableGrantsId");
}
function sortDivChildren(divName_){
  var children = $(divName_).children().sort(function (a,b){
      var vA = $(a).attr('id');
      var vB = $(b).attr('id');
      return (vA < vB) ? -1 : (vA > vB) ? 1 : 0;
      });
  $(divName_).children().remove();
  $(divName_).append(children);
  makeDragable(divName_ + " .securityGrant");
}


//]]>

</script>
<div id="[%divId%]" class="contentPane MainLayout"  >
  <h1 id="[%divId%]GolferNameId" class="pageTitle">Security Grants</h1>
  <div class="row">
    <span class="fourcol">
      <table id="[%divId%]ListTable"  class='dataTable' >
      </table>
    </span>
    <span class = "eightcol last">
      <div class="formLayout_Standard">
	<form id="[%divId%]Form" >

	  [%dbColumnName = 'profile_name'%]
	  <div class="formFieldGroup" id="[%divId%]Form-[%dbColumnName%]DivId">
	    <label for ="[%divId%]Form-[%dbColumnName%]" id="[%divId%]FormLabel-[%dbColumnName%]">Profile Name</label>
	    <input  type="text" class="VALIDATEinteger" name="[%toCC(dbColumnName)%]" id="[%divId%]Form-[%dbColumnName%]"/>
	    <span class="ValidationMsg" id="[%divId%]FormLabel-[%toCC(dbColumnName)%]Error"></span>
	  </div>
	  <div class="formButtons">

	    <button type="button" id="[%divId%]FormSave" value="Save" onclick="save[%ucfirst(divId)%]Form();" >
	      Save</button>
	    <button type="button" id="[%divId%]FormAdd" value="Add" onclick="save[%ucfirst(divId)%]Form();" >
	      Add</button>
	    <button type="button" id="[%divId%]FormClear" value="Clear" 
	      onclick="clearForm('[%divId%]Form');makeAvailableAllPrivileges();" >Clear</button>
	  </div>
	  <input type="hidden" name="last_update" id="[%divId%]Form-last_update">
	  <input type="hidden" name="[%prkey%]" id="[%divId%]Form-[%prkey%]">
	</form>
      </div>
      <br/>
      <div id="grantAssignDiv">
	<div id="availableGrantsId" size="15" class="securityGrantReceiver"></div>
	<span class="sprite32Icon plusIcon"></span>
	<span class="sprite32Icon cancelIcon"></span>
	<div id="grantedPrivilegesId" size="15" class="securityGrantReceiver">&nbsp;</div>
      </div>
    </div>
  </div> <!--end:[%ucfirst(divId)%]-->
